---
title: 插件原理
description: Paper 中插件的工作方式
slug: paper/dev/how-do-plugins-work
---

插件是扩展 Minecraft 服务器功能的一种方式。
它们使用基于 JVM 的语言编写，例如 Java、Kotlin、Groovy 或 Scala。插件从服务器目录中的 `plugins` 文件夹加载。
插件将从一个 `.jar` 文件加载。
每个插件都有一个主类，该类在插件的 `plugin.yml` 文件中指定。
这个类必须继承自 `JavaPlugin`，并且是插件的入口点，也是定义插件生命周期方法的地方。

:::caution

我们不推荐在主类的构造函数中编写代码，因为此时无法保证哪些 API 是可用的。
相反，你应该使用 `onLoad` 方法来初始化你的插件。
此外，不要直接调用你的插件的构造函数。这将导致插件出现问题。

:::

## 插件生命周期

插件在运行时加载和卸载。当插件被加载时，它被初始化并启用。
当插件被卸载时，它被禁用并完成。

### 初始化

当插件被加载时，它被初始化。这意味着插件被加载到内存中，并且它的 `onLoad` 方法被调用。
这个方法用于初始化插件并设置它需要的任何资源。
此时大部分 Bukkit API 是不可用的，因此与它交互是不安全的。

### 启用

当插件被启用时，会调用它的 `onEnable` 方法。
这个方法用于设置插件运行所需的任何资源。
这个方法在插件初始化后但在服务器开始计时之前被调用，因此注册事件监听器和其他插件运行所需资源是安全的，但通常不建议与很多 API 进行交互。

这也是你可以打开数据库连接、启动线程以及执行其他在 `onLoad` 方法中不安全的操作的时候。

### 禁用

当插件被禁用时，它的 `onDisable` 方法被调用。 这个方法用于清理插件分配的任何资源。
这个方法在所有插件被卸载之前被调用，用于在插件被卸载之前需要完成的任何清理工作。
这可能包括将数据保存到磁盘或关闭与数据库的连接。

## 事件监听器

事件是插件监听服务器中发生的事情并在它们被触发时运行代码的一种方式。
例如，当玩家加入服务器时会触发 [`PlayerJoinEvent`](jd:paper:org.bukkit.event.player.PlayerJoinEvent) 。
这是一种更高效的运行代码的方式，而不是不断地进行检查。
更多信息请参阅我们的 [事件监听器页面](/paper/dev/event-listeners)。

有些事件是可以取消的。这意味着当事件被触发时，它可以被取消，从而否定或停止事件的效果。
例如， [`PlayerMoveEvent`](jd:paper:org.bukkit.event.player.PlayerMoveEvent) 是可以取消的。
这意味着当它被取消时，玩家不会移动。
这对于反作弊等事情很有用，例如如果玩家移动得太快，你可以取消该事件。

在编写事件监听器时，考虑事件的触发频率很重要。
“热”事件是指频繁触发的事件。例如，`PlayerMoveEvent` 每次玩家移动时都会触发。
这意味着如果你的事件监听器中有大量复杂的代码，它将在每次玩家移动时运行。
这可能会导致大量延迟。 保持事件监听器尽可能轻量级是很重要的。
一种可能的方法是快速检查事件是否应该被处理，如果不应该，则直接返回。
例如，如果你只想在玩家从一个方块移动到另一个方块时处理事件，你可以检查玩家的位置是否改变了方块。如果没有，你可以从监听器中返回。

## 命令

命令是玩家、控制台、RCON 和命令方块在服务器上运行代码的一种方式。命令由插件注册，并可由命令发送者运行。
例如，`/help` 命令由服务器注册，并可由玩家运行。
玩家可以通过在聊天中输入命令或从命令方块运行来执行命令。

命令可以有参数。例如，`/give` 命令接受一个参数，指定要给予物品的玩家，以及一个参数，指定要给予的物品。参数由空格分隔。
例如，命令 `/give Notch diamond` 将给予名为 Notch 的玩家一个钻石。
注意这里的参数是 `["Notch", "diamond"]`。

### 权限

权限是一种控制谁可以运行命令以及谁可以监听事件的方式。
权限由插件注册，并可由其他插件检查。
权限可以授予玩家和组。如果插件在其 `plugin.yml` 中定义，权限可以具有层次结构。
例如，一个插件可以将 `example.command.help` 定义为 `example.command` 的子权限。
这意味着如果玩家具有 `example.command` 权限，他们也将具有 `example.command.help` 权限。

:::note

权限插件可以使用 `*` 字符来允许使用通配符权限，以授予任何可用的权限或子权限，即使插件本身没有设置，也可以实现层次化权限。
例如，通过支持通配符的权限插件授予 `example.command.*`，将允许访问所有以 `example.command.` 开头的权限。

不推荐使用通配符权限，尤其是 `*`（所有权限），因为这可能会带来巨大的安全风险，并且可能会对玩家产生意外的副作用。
使用时需谨慎。

:::

## 配置

插件可以有配置文件。这些文件用于存储插件运行所需的数据。例如，添加新方块到游戏的插件可能会有一个配置文件，用于存储方块的 ID。
配置文件应存储在插件的数据文件夹中，位于 `plugins` 文件夹内。
服务器提供了一个 YAML 配置 API，可用于读取和写入配置文件。
更多信息请参阅 [这里](/paper/dev/plugin-configurations)。

## 安排任务

插件可以安排任务在稍后运行。这对于在特定时间后运行代码非常有用。
例如，一个插件可能希望在 5 秒后运行代码。
这可以通过安排一个任务在 100 个刻之后运行来实现——在正常运行时，1 秒等于 20 个刻。
需要注意的是，如果服务器出现延迟，任务可能会被推迟。
例如，如果服务器每秒只运行 10 个刻，那么一个安排在 100 个刻后运行的任务将需要 10 秒。

在 Java 中，通常你可以使用 [`Thread#sleep()`](jd:java:java.lang.Thread#sleep(long)) 来延迟代码的执行。
然而，如果代码在主线程上运行，这将导致服务器在延迟期间暂停。
相反，你应该使用 `Scheduler` API 来安排任务稍后运行。更多关于 `Scheduler` API 的信息可以在[这里](/paper/dev/scheduler)找到。

## 组件（Adventure）

自 Minecraft 1.7 引入“组件”以来，插件现在可以向玩家发送包含富文本的消息。
这意味着插件可以发送包含颜色、粗体文本和可点击链接等内容的消息。
颜色一直是可能的，但只能通过使用旧版颜色代码。

Paper 实现了一个名为 `Adventure` 的库，它使得向玩家发送消息变得简单。
你可以从它们的文档 [这里](https://docs.advntr.dev/)
或我们的文档 [这里](/paper/dev/component-api/introduction) 了解更多信息。
